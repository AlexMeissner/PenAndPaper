@using System.Net
@using ApiClient
@using DataTransfer.Character
@using Markdig
@using Website.Services

@inject ICharacterApi CharacterApi
@inject IDragAndDrop DragAndDrop
@inject ILogger<Character> Logger
@inject IJSRuntime JsRuntime

<div class="character-root">
    @if (_isEditMode)
    {
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text">Charaktername</span>
                <input class="form-control" type="text" @bind="_character.Name" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="input-group mb-3">
                    <span class="input-group-text">Trefferpunkte</span>
                    <input class="form-control" type="number" min="1" @bind="_character.HitPoints" />
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Rüstungsklasse</span>
                    <input class="form-control" type="number" min="1" @bind="_character.ArmorClass" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Bewegungsrate</label>
                    <textarea class="form-control" rows="2" @bind="_character.Speed"></textarea>
                </div>

                <div class="input-group mb-3">
                    <span class="input-group-text">Volk</span>
                    <select class="form-select" @bind="_character.Race">
                        <option>Elf</option>
                        <option>Halblinge</option>
                        <option>Menschen</option>
                        <option>Zwerge</option>
                        <option>Drachenblütige</option>
                        <option>Gnome</option>
                        <option>Halborks</option>
                        <option>Tieflinge</option>
                    </select>
                </div>
            </div>

            <div class="col-md-6">
                <div class="characters-item edit-image">
                    <img src="data:image/png;base64,@Convert.ToBase64String(_character.Image)" @onclick="OnLoadImage" alt="Auf diesen Text klicken, um ein Bild zu wählen" />
                    <InputFile id="characterCreationInputFile" OnChange="async (e) => { await LoadCharacterImage(e, _character); StateHasChanged(); }" accept="image/png, image/jpeg, image/jpg"
                               style="display: none"></InputFile>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label">Attribute</label>
                <div class="stats-grid mb-3">
                    <div class="attribute-box">
                        <div class="attr-upper">STÄRKE</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="1" max="20" step="1" @bind="_character.Strength" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">GESCHICKLICHKEIT</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="1" max="20" step="1" @bind="_character.Dexterity" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">KONSTITUTION</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="1" max="20" step="1" @bind="_character.Constitution" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">INTELLIGENZ</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="1" max="20" step="1" @bind="_character.Intelligence" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">WEISEHEIT</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="1" max="20" step="1" @bind="_character.Wisdom" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">CHARISMA</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="1" max="20" step="1" @bind="_character.Charisma" />
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <label class="form-label">Rettungswürfe</label>
                <div class="stats-grid mb-3">
                    <div class="attribute-box">
                        <div class="attr-upper">STÄRKE</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="-20" max="20" step="1" @bind="_character.SavingThrowStrength" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">GESCHICKLICHKEIT</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="-20" max="20" step="1" @bind="_character.SavingThrowDexterity" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">KONSTITUTION</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="-20" max="20" step="1" @bind="_character.SavingThrowConstitution" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">INTELLIGENZ</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="-20" max="20" step="1" @bind="_character.SavingThrowIntelligence" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">WEISEHEIT</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="-20" max="20" step="1" @bind="_character.SavingThrowWisdom" />
                        </div>
                    </div>
                    <div class="attribute-box">
                        <div class="attr-upper">CHARISMA</div>
                        <div class="attr-lower">
                            <input class="form-control" type="number" min="-20" max="20" step="1" @bind="_character.SavingThrowCharisma" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="classes-area mb-3">
            <label class="form-label">Klasse</label>
            <div class="d-flex align-items-center mb-2 class-item">
                <select class="form-select me-2" style="max-width: 300px;" @bind="_character.Class">
                    <option>Barbar</option>
                    <option>Barde</option>
                    <option>Druide</option>
                    <option>Hexenmeister</option>
                    <option>Kämpfer</option>
                    <option>Kleriker</option>
                    <option>Magier</option>
                    <option>Mönch</option>
                    <option>Paladin</option>
                    <option>Schurke</option>
                    <option>Waldläufer</option>
                    <option>Zauberer</option>
                </select>
                <input class="form-control me-2" type="number" min="1" max="20" style="width:100px;" @bind="_character.Level" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Hintergrund</label>
            <select class="form-select" @bind="_character.Background">
                <option>Adeliger</option>
                <option>Ritter</option>
                <option>Einsidler</option>
                <option>Zufthandwerker</option>
                <option>Gildenkaufmann</option>
                <option>Krimineller</option>
                <option>Spion</option>
                <option>Scharlatan</option>
                <option>Seemann</option>
                <option>Pirat</option>
                <option>Soldat</option>
                <option>Sonderling</option>
                <option>Strassenkind</option>
                <option>Tempeldiener</option>
                <option>Unterhaltungskünstler</option>
                <option>Gladiator</option>
                <option>Volksheld</option>
                <option>Weiser</option>
            </select>
        </div>

        <div class="mb-3 traits-area">
            <label class="form-label">Fähigkeiten</label>
            <div class="skills">
                <div class="skills-column">
                    <div class="skill-item"><span>Akrobatik</span><input type="number" min="1" max="20" @bind="_character.Acrobatics" /></div>
                    <div class="skill-item"><span>Arkane Kunde</span><input type="number" min="1" max="20" @bind="_character.Arcana" /></div>
                    <div class="skill-item"><span>Athletik</span><input type="number" min="1" max="20" @bind="_character.Athletics" /></div>
                    <div class="skill-item"><span>Auftreten</span><input type="number" min="1" max="20" @bind="_character.Performance" /></div>
                    <div class="skill-item"><span>Einschüchtern</span><input type="number" min="1" max="20" @bind="_character.Intimidation" /></div>
                    <div class="skill-item"><span>Fingerfertigkeit</span><input type="number" min="1" max="20" @bind="_character.SlightOfHand" /></div>
                </div>
                <div class="skills-column">
                    <div class="skill-item"><span>Geschichte</span><input type="number" min="1" max="20" @bind="_character.History" /></div>
                    <div class="skill-item"><span>Heilkunde</span><input type="number" min="1" max="20" @bind="_character.Medicine" /></div>
                    <div class="skill-item"><span>Heimlichkeit</span><input type="number" min="1" max="20" @bind="_character.Stealth" /></div>
                    <div class="skill-item"><span>Mit Tieren umgehen</span><input type="number" min="1" max="20" @bind="_character.AnimalHandling" /></div>
                    <div class="skill-item"><span>Motiv erkennen</span><input type="number" min="1" max="20" @bind="_character.Insight" /></div>
                    <div class="skill-item"><span>Nachforschungen</span><input type="number" min="1" max="20" @bind="_character.Investigation" /></div>
                </div>
                <div class="skills-column">
                    <div class="skill-item"><span>Naturkunde</span><input type="number" min="1" max="20" @bind="_character.Nature" /></div>
                    <div class="skill-item"><span>Religion</span><input type="number" min="1" max="20" @bind="_character.Religion" /></div>
                    <div class="skill-item"><span>Täuschen</span><input type="number" min="1" max="20" @bind="_character.Deception" /></div>
                    <div class="skill-item"><span>Überlebenskunst</span><input type="number" min="1" max="20" @bind="_character.Survival" /></div>
                    <div class="skill-item"><span>Überzeugen</span><input type="number" min="1" max="20" @bind="_character.Persuasion" /></div>
                    <div class="skill-item"><span>Wahrnehmung</span><input type="number" min="1" max="20" @bind="_character.Perception" /></div>
                </div>
            </div>
        </div>

        <div class="mb-3 traits-area">
            <label class="form-label">Merkmale</label>
            <textarea class="form-control" style="min-height:300px;" @bind="_character.Traits"></textarea>
        </div>

        <div class="mb-3 traits-area">
            <label class="form-label">Angriff</label>
            <textarea class="form-control" style="min-height:300px;" @bind="_character.Attacks"></textarea>
        </div>

        <div class="mb-3 traits-area">
            <label class="form-label">Zauber</label>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 1 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.FirstLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 2 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.SecondLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 3 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.ThirdLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 4 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.FourthLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 5 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.FifthLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 6 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.SixthLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 7 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.SeventhLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 8 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.EighthLevelSpellSlotTotal">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text">Verfügbare Rang 9 Zauberslots</span>
                <input type="number" class="form-control" @bind="_character.NinthLevelSpellSlotTotal">
            </div>
            <textarea class="form-control" style="min-height:300px;" @bind="_character.Spells"></textarea>
        </div>

        <div class="mb-3 traits-area">
            <label class="form-label">Inventar</label>
            <textarea class="form-control" style="min-height:300px;" @bind="_character.Inventory"></textarea>
        </div>

        <button class="btn btn-success" type="button" @onclick="OnSave">Speichern</button>
    }
    else if (_character is not null)
    {
        <div class="characters">
            <div class="characters-top">
                <div class="characters-left">
                    <div class="characters-top-row">
                        <div class="character-title">
                            <h3>@_character.Name</h3>
                        </div>

                        <button class="edit-button" type="button" @onclick="OnEdit">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="#ffffff">
                                <path d="M416.9 85.2L372 130.1L509.9 268L554.8 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64C448.8 64 430.4 71.6 416.9 85.2zM338.1 164L122.9 379.1C112.2 389.8 104.4 403.2 100.3 417.8L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L476 301.9L338.1 164z" />
                            </svg>
                        </button>

                        <div class="character-details">
                            <span class="character-detail">@_character.Race</span>
                            <span class="character-detail">@_character.Class</span>
                            <span class="character-detail">@_character.Level</span>
                            <span class="character-detail">@_character.Background</span>
                        </div>
                    </div>

                    <div class="stat-row">
                        <div class="stat-box">
                            <div class="stat-label">Rüstungsklasse</div>
                            <div class="stat-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="#ffffff"><path d="M320 64C324.6 64 329.2 65 333.4 66.9L521.8 146.8C543.8 156.1 560.2 177.8 560.1 204C559.6 303.2 518.8 484.7 346.5 567.2C329.8 575.2 310.4 575.2 293.7 567.2C121.3 484.7 80.6 303.2 80.1 204C80 177.8 96.4 156.1 118.4 146.8L306.7 66.9C310.9 65 315.4 64 320 64z" /></svg>
                                <div>@_character.ArmorClass</div>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">Bewegungsrate</div>
                            <div class="stat-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="#ffffff"><path d="M352.5 32C383.4 32 408.5 57.1 408.5 88C408.5 118.9 383.4 144 352.5 144C321.6 144 296.5 118.9 296.5 88C296.5 57.1 321.6 32 352.5 32zM219.6 240C216.3 240 213.4 242 212.2 245L190.2 299.9C183.6 316.3 165 324.3 148.6 317.7C132.2 311.1 124.2 292.5 130.8 276.1L152.7 221.2C163.7 193.9 190.1 176 219.6 176L316.9 176C345.4 176 371.7 191.1 386 215.7L418.8 272L480.4 272C498.1 272 512.4 286.3 512.4 304C512.4 321.7 498.1 336 480.4 336L418.8 336C396 336 375 323.9 363.5 304.2L353.5 287.1L332.8 357.5L408.2 380.1C435.9 388.4 450 419.1 438.3 445.6L381.7 573C374.5 589.2 355.6 596.4 339.5 589.2C323.4 582 316.1 563.1 323.3 547L372.5 436.2L276.6 407.4C243.9 397.6 224.6 363.7 232.9 330.6L255.6 240L219.7 240zM211.6 421C224.9 435.9 242.3 447.3 262.8 453.4L267.5 454.8L260.6 474.1C254.8 490.4 244.6 504.9 231.3 515.9L148.9 583.8C135.3 595 115.1 593.1 103.9 579.5C92.7 565.9 94.6 545.7 108.2 534.5L190.6 466.6C195.1 462.9 198.4 458.1 200.4 452.7L211.6 421z" /></svg>
                                <div>@_character.Speed</div>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">Trefferpunkte</div>
                            <div class="stat-value">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="#ffffff"><path d="M305 151.1L320 171.8L335 151.1C360 116.5 400.2 96 442.9 96C516.4 96 576 155.6 576 229.1L576 231.7C576 343.9 436.1 474.2 363.1 529.9C350.7 539.3 335.5 544 320 544C304.5 544 289.2 539.4 276.9 529.9C203.9 474.2 64 343.9 64 231.7L64 229.1C64 155.6 123.6 96 197.1 96C239.8 96 280 116.5 305 151.1z" /></svg>
                                <input type="number" style="width: 60px" min="0" @bind="_character.CurrentPoints" @bind:after="async () => await OnHitPointsChanged(_character.CurrentPoints)" />
                                <span>/ @_character.HitPoints</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="characters-item characters-item-large" draggable="true" @ondragstart="() => OnDragStart(_character)">
                    <img class="character-icon" src="data:image/png;base64,@Convert.ToBase64String(_character.Image)" alt="Icon" />
                </div>
            </div>
            <h3>Attribute</h3>
            <div class="attributes">
                <div class="attribute-box">
                    <div class="attribute-name">STÄRKE</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(AbilityModifier(_character.Strength))</div>
                        <div class="ability-score">@_character.Strength</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">GESCHICKLICHKEIT</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(AbilityModifier(_character.Dexterity))</div>
                        <div class="ability-score">@_character.Dexterity</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">KONSTITUTION</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(AbilityModifier(_character.Constitution))</div>
                        <div class="ability-score">@_character.Constitution</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">INTELLIGENZ</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(AbilityModifier(_character.Intelligence))</div>
                        <div class="ability-score">@_character.Intelligence</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">WEISHEIT</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(AbilityModifier(_character.Wisdom))</div>
                        <div class="ability-score">@_character.Wisdom</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">CHARISMA</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(AbilityModifier(_character.Charisma))</div>
                        <div class="ability-score">@_character.Charisma</div>
                    </div>
                </div>
            </div>
            <h3>Rettungswürfe</h3>
            <div class="attributes">
                <div class="attribute-box">
                    <div class="attribute-name">STÄRKE</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(_character.SavingThrowStrength)</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">GESCHICKLICHKEIT</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(_character.SavingThrowDexterity)</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">KONSTITUTION</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(_character.SavingThrowConstitution)</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">INTELLIGENZ</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(_character.SavingThrowIntelligence)</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">WEISHEIT</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(_character.SavingThrowWisdom)</div>
                    </div>
                </div>
                <div class="attribute-box">
                    <div class="attribute-name">CHARISMA</div>
                    <div class="attribute-visuals">
                        <div class="modifier-oval">@FormatSkill(_character.SavingThrowCharisma)</div>
                    </div>
                </div>
            </div>
            <h3>Fertigkeiten</h3>
            <div class="skills">
                <div class="skills-column">
                    <div class="skill-item"><span>Akrobatik</span><span class="skill-value">@FormatSkill(_character.Acrobatics)</span></div>
                    <div class="skill-item"><span>Arkane Kunde</span><span class="skill-value">@FormatSkill(_character.Arcana)</span></div>
                    <div class="skill-item"><span>Athletik</span><span class="skill-value">@FormatSkill(_character.Athletics)</span></div>
                    <div class="skill-item"><span>Auftreten</span><span class="skill-value">@FormatSkill(_character.Performance)</span></div>
                    <div class="skill-item"><span>Einschüchtern</span><span class="skill-value">@FormatSkill(_character.Intimidation)</span></div>
                    <div class="skill-item"><span>Fingerfertigkeit</span><span class="skill-value">@FormatSkill(_character.SlightOfHand)</span></div>
                </div>
                <div class="skills-column">
                    <div class="skill-item"><span>Geschichte</span><span class="skill-value">@FormatSkill(_character.History)</span></div>
                    <div class="skill-item"><span>Heilkunde</span><span class="skill-value">@FormatSkill(_character.Medicine)</span></div>
                    <div class="skill-item"><span>Heimlichkeit</span><span class="skill-value">@FormatSkill(_character.Stealth)</span></div>
                    <div class="skill-item"><span>Mit Tieren umgehen</span><span class="skill-value">@FormatSkill(_character.AnimalHandling)</span></div>
                    <div class="skill-item"><span>Motiv erkennen</span><span class="skill-value">@FormatSkill(_character.Insight)</span></div>
                    <div class="skill-item"><span>Nachforschungen</span><span class="skill-value">@FormatSkill(_character.Investigation)</span></div>
                </div>
                <div class="skills-column">
                    <div class="skill-item"><span>Naturkunde</span><span class="skill-value">@FormatSkill(_character.Nature)</span></div>
                    <div class="skill-item"><span>Religion</span><span class="skill-value">@FormatSkill(_character.Religion)</span></div>
                    <div class="skill-item"><span>Täuschen</span><span class="skill-value">@FormatSkill(_character.Deception)</span></div>
                    <div class="skill-item"><span>Überlebenskunst</span><span class="skill-value">@FormatSkill(_character.Survival)</span></div>
                    <div class="skill-item"><span>Überzeugen</span><span class="skill-value">@FormatSkill(_character.Persuasion)</span></div>
                    <div class="skill-item"><span>Wahrnehmung</span><span class="skill-value">@FormatSkill(_character.Perception)</span></div>
                </div>
            </div>
            <h3>Merkmale</h3>
            <div>@_character.TraitsHtml</div>
            <h3>Angriff</h3>
            <div>@_character.AttacksHtml</div>
            <h3>Zauber</h3>
            <div>
                <span>Rang 1</span>
                <input type="range" min="0" max="@_character.FirstLevelSpellSlotTotal" @bind="_character.FirstLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(1, _character.FirstLevelSpellSlotUsed)" step="1" />
                <span>@_character.FirstLevelSpellSlotUsed / @_character.FirstLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 2</span>
                <input type="range" min="0" max="@_character.SecondLevelSpellSlotTotal" @bind="_character.SecondLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(2, _character.SecondLevelSpellSlotUsed)" step="1" />
                <span>@_character.SecondLevelSpellSlotUsed / @_character.SecondLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 3</span>
                <input type="range" min="0" max="@_character.ThirdLevelSpellSlotTotal" @bind="_character.ThirdLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(3, _character.ThirdLevelSpellSlotUsed)" step="1" />
                <span>@_character.ThirdLevelSpellSlotUsed / @_character.ThirdLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 4</span>
                <input type="range" min="0" max="@_character.FourthLevelSpellSlotTotal" @bind="_character.FourthLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(4, _character.FourthLevelSpellSlotUsed)" step="1" />
                <span>@_character.FourthLevelSpellSlotUsed / @_character.FourthLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 5</span>
                <input type="range" min="0" max="@_character.FifthLevelSpellSlotTotal" @bind="_character.FifthLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(5, _character.FifthLevelSpellSlotUsed)" step="1" />
                <span>@_character.FifthLevelSpellSlotUsed / @_character.FifthLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 6</span>
                <input type="range" min="0" max="@_character.SixthLevelSpellSlotTotal" @bind="_character.SixthLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(6, _character.SixthLevelSpellSlotUsed)" step="1" />
                <span>@_character.SixthLevelSpellSlotUsed / @_character.SixthLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 7</span>
                <input type="range" min="0" max="@_character.SeventhLevelSpellSlotTotal" @bind="_character.SeventhLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(7, _character.SeventhLevelSpellSlotUsed)" step="1" />
                <span>@_character.SeventhLevelSpellSlotUsed / @_character.SeventhLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 8</span>
                <input type="range" min="0" max="@_character.EighthLevelSpellSlotTotal" @bind="_character.EighthLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(8, _character.EighthLevelSpellSlotUsed)" step="1" />
                <span>@_character.EighthLevelSpellSlotUsed / @_character.EighthLevelSpellSlotTotal</span>
            </div>
            <div>
                <span>Rang 9</span>
                <input type="range" min="0" max="@_character.NinthLevelSpellSlotTotal" @bind="_character.NinthLevelSpellSlotUsed" @bind:after="async () => await OnSpellSlotChanged(9, _character.NinthLevelSpellSlotUsed)" step="1" />
                <span>@_character.NinthLevelSpellSlotUsed / @_character.NinthLevelSpellSlotTotal</span>
            </div>
            <div>@_character.SpellsHtml</div>
            <h3>Inventar</h3>
            <div>@_character.InventoryHtml</div>
        </div>
    }
</div>

@code {
    [Parameter] public int CampaignId { get; set; }

    private bool _isEditMode = false;

    private int? _characterId;

    public void CreateNewCharacter()
    {
        _characterId = null;
        _character = GenerateEmptyCharacterInformation();
        _isEditMode = true;
        StateHasChanged();
    }

    public async Task SetCharacter(int characterId)
    {
        var response = await CharacterApi.GetAsync(characterId);

        response.Match(
            character =>
            {
                _isEditMode = false;
                _character = GenerateCharacterInformation(character);
                _characterId = characterId;
            },
            statusCode =>
            {
                Logger.LogError("Failed to load character with id {CharacterId}. Status code: {StatusCode}", characterId, statusCode);
            }
        );

        StateHasChanged();
    }

    private class CharacterInformation
    {
        public required string Name { get; set; }
        public int ArmorClass { get; set; }
        public int HitPoints { get; set; }
        public int CurrentPoints { get; set; }
        public required string HitDice { get; set; }
        public required string Speed { get; set; }
        public required string Race { get; set; }
        public required string Class { get; set; }
        public int Level { get; set; }

        public int Strength { get; set; }
        public int Dexterity { get; set; }
        public int Constitution { get; set; }
        public int Intelligence { get; set; }
        public int Wisdom { get; set; }
        public int Charisma { get; set; }

        public int SavingThrowStrength { get; set; }
        public int SavingThrowDexterity { get; set; }
        public int SavingThrowConstitution { get; set; }
        public int SavingThrowIntelligence { get; set; }
        public int SavingThrowWisdom { get; set; }
        public int SavingThrowCharisma { get; set; }
        public int Acrobatics { get; set; }
        public int AnimalHandling { get; set; }
        public int Arcana { get; set; }
        public int Athletics { get; set; }
        public int Deception { get; set; }
        public int History { get; set; }
        public int Insight { get; set; }
        public int Intimidation { get; set; }
        public int Investigation { get; set; }
        public int Medicine { get; set; }
        public int Nature { get; set; }
        public int Perception { get; set; }
        public int Performance { get; set; }
        public int Persuasion { get; set; }
        public int Religion { get; set; }
        public int SlightOfHand { get; set; }
        public int Stealth { get; set; }
        public int Survival { get; set; }

        public int FirstLevelSpellSlotTotal { get; set; }
        public int FirstLevelSpellSlotUsed { get; set; }
        public int SecondLevelSpellSlotTotal { get; set; }
        public int SecondLevelSpellSlotUsed { get; set; }
        public int ThirdLevelSpellSlotTotal { get; set; }
        public int ThirdLevelSpellSlotUsed { get; set; }
        public int FourthLevelSpellSlotTotal { get; set; }
        public int FourthLevelSpellSlotUsed { get; set; }
        public int FifthLevelSpellSlotTotal { get; set; }
        public int FifthLevelSpellSlotUsed { get; set; }
        public int SixthLevelSpellSlotTotal { get; set; }
        public int SixthLevelSpellSlotUsed { get; set; }
        public int SeventhLevelSpellSlotTotal { get; set; }
        public int SeventhLevelSpellSlotUsed { get; set; }
        public int EighthLevelSpellSlotTotal { get; set; }
        public int EighthLevelSpellSlotUsed { get; set; }
        public int NinthLevelSpellSlotTotal { get; set; }
        public int NinthLevelSpellSlotUsed { get; set; }

        public required byte[] Image { get; set; }

        public required string Background { get; set; }
        public required string Traits { get; set; }
        public required string Attacks { get; set; }
        public required string Spells { get; set; }
        public required string Inventory { get; set; }

        public MarkupString TraitsHtml => new MarkupString(Markdown.ToHtml(Traits));
        public MarkupString AttacksHtml => new MarkupString(Markdown.ToHtml(Attacks));
        public MarkupString SpellsHtml => new MarkupString(Markdown.ToHtml(Spells));
        public MarkupString InventoryHtml => new MarkupString(Markdown.ToHtml(Inventory));

    }

    private CharacterInformation _character = GenerateEmptyCharacterInformation();

    private static CharacterInformation GenerateEmptyCharacterInformation()
    {
        return new()
        {
            Name = "",
            HitDice = "",
            Speed = "",
            Race = "Menschen",
            Class = "Barbar",
            Background = "Adeliger",
            Traits = "",
            Attacks = "",
            Spells = "",
            Inventory = "",
            Image = Array.Empty<byte>()
        };
    }

    private static CharacterInformation GenerateCharacterInformation(CharacterDto payload)
    {
        return new()
        {
            Name = payload.Name,
            ArmorClass = payload.ArmorClass,
            HitPoints = payload.HitPoints,
            CurrentPoints = payload.CurrentHitPoints,
            HitDice = payload.HitDice,
            Speed = payload.Speed,
            Race = payload.Race,
            Class = payload.Class,
            Level = payload.Level,
            Strength = payload.Strength,
            Dexterity = payload.Dexterity,
            Constitution = payload.Constitution,
            Intelligence = payload.Intelligence,
            Wisdom = payload.Wisdom,
            Charisma = payload.Charisma,
            SavingThrowStrength = payload.SavingThrowStrength,
            SavingThrowDexterity = payload.SavingThrowDexterity,
            SavingThrowConstitution = payload.SavingThrowConstitution,
            SavingThrowIntelligence = payload.SavingThrowIntelligence,
            SavingThrowWisdom = payload.SavingThrowWisdom,
            SavingThrowCharisma = payload.SavingThrowCharisma,
            Acrobatics = payload.Acrobatics,
            AnimalHandling = payload.AnimalHandling,
            Arcana = payload.Arcana,
            Athletics = payload.Athletics,
            Deception = payload.Deception,
            History = payload.History,
            Insight = payload.Insight,
            Intimidation = payload.Intimidation,
            Investigation = payload.Investigation,
            Medicine = payload.Medicine,
            Nature = payload.Nature,
            Perception = payload.Perception,
            Performance = payload.Performance,
            Persuasion = payload.Persuasion,
            Religion = payload.Religion,
            SlightOfHand = payload.SlightOfHand,
            Stealth = payload.Stealth,
            Survival = payload.Survival,
            FirstLevelSpellSlotTotal = payload.FirstLevelSpellSlotTotal,
            FirstLevelSpellSlotUsed = payload.FirstLevelSpellSlotUsed,
            SecondLevelSpellSlotTotal = payload.SecondLevelSpellSlotTotal,
            SecondLevelSpellSlotUsed = payload.SecondLevelSpellSlotUsed,
            ThirdLevelSpellSlotTotal = payload.ThirdLevelSpellSlotTotal,
            ThirdLevelSpellSlotUsed = payload.ThirdLevelSpellSlotUsed,
            FourthLevelSpellSlotTotal = payload.FourthLevelSpellSlotTotal,
            FourthLevelSpellSlotUsed = payload.FourthLevelSpellSlotUsed,
            FifthLevelSpellSlotTotal = payload.FifthLevelSpellSlotTotal,
            FifthLevelSpellSlotUsed = payload.FifthLevelSpellSlotUsed,
            SixthLevelSpellSlotTotal = payload.SixthLevelSpellSlotTotal,
            SixthLevelSpellSlotUsed = payload.SixthLevelSpellSlotUsed,
            SeventhLevelSpellSlotTotal = payload.SeventhLevelSpellSlotTotal,
            SeventhLevelSpellSlotUsed = payload.SeventhLevelSpellSlotUsed,
            EighthLevelSpellSlotTotal = payload.EighthLevelSpellSlotTotal,
            EighthLevelSpellSlotUsed = payload.EighthLevelSpellSlotUsed,
            NinthLevelSpellSlotTotal = payload.NinthLevelSpellSlotTotal,
            NinthLevelSpellSlotUsed = payload.NinthLevelSpellSlotUsed,
            Image = payload.Image,
            Background = payload.Background,
            Traits = payload.Traits,
            Attacks = payload.Attacks,
            Spells = payload.Spells,
            Inventory = payload.Inventory
        };
    }

    private async Task OnSave(MouseEventArgs args)
    {
        // ToDo: Add user feedback
        if (_character.Image.Length == 0) return;

        bool success = false;

        if (_characterId is { } characterId)
        {
            var payload = new CharacterUpdateDto(
                _character.Name,
                _character.Image,
                _character.HitPoints,
                _character.HitDice,
                _character.ArmorClass,
                _character.Speed,
                _character.Race,
                _character.Class,
                _character.Level,
                _character.Background,
                _character.Traits,
                _character.Attacks,
                _character.Spells,
                _character.Inventory,
                _character.Strength,
                _character.Dexterity,
                _character.Constitution,
                _character.Intelligence,
                _character.Wisdom,
                _character.Charisma,
                _character.SavingThrowStrength,
                _character.SavingThrowDexterity,
                _character.SavingThrowConstitution,
                _character.SavingThrowIntelligence,
                _character.SavingThrowWisdom,
                _character.SavingThrowCharisma,
                _character.Acrobatics,
                _character.AnimalHandling,
                _character.Arcana,
                _character.Athletics,
                _character.Deception,
                _character.History,
                _character.Insight,
                _character.Intimidation,
                _character.Investigation,
                _character.Medicine,
                _character.Nature,
                _character.Perception,
                _character.Performance,
                _character.Persuasion,
                _character.Religion,
                _character.SlightOfHand,
                _character.Stealth,
                _character.Survival,
                new(_character.FirstLevelSpellSlotTotal, _character.FirstLevelSpellSlotUsed),
                new(_character.SecondLevelSpellSlotTotal, _character.SecondLevelSpellSlotUsed),
                new(_character.ThirdLevelSpellSlotTotal, _character.ThirdLevelSpellSlotUsed),
                new(_character.FourthLevelSpellSlotTotal, _character.FourthLevelSpellSlotUsed),
                new(_character.FifthLevelSpellSlotTotal, _character.FifthLevelSpellSlotUsed),
                new(_character.SixthLevelSpellSlotTotal, _character.SixthLevelSpellSlotUsed),
                new(_character.SeventhLevelSpellSlotTotal, _character.SeventhLevelSpellSlotUsed),
                new(_character.EighthLevelSpellSlotTotal, _character.EighthLevelSpellSlotUsed),
                new(_character.NinthLevelSpellSlotTotal, _character.NinthLevelSpellSlotUsed)
            );

            var response = await CharacterApi.UpdateAsync(characterId, payload);
            success = response.IsSuccess;
        }
        else // New character
        {
            var character = new CharacterCreationDto(
                _character.Name,
                _character.Image,
                _character.HitPoints,
                _character.HitDice,
                _character.ArmorClass,
                _character.Speed,
                _character.Race,
                _character.Class,
                _character.Level,
                _character.Background,
                _character.Traits,
                _character.Attacks,
                _character.Spells,
                _character.Inventory,
                _character.Strength,
                _character.Dexterity,
                _character.Constitution,
                _character.Intelligence,
                _character.Wisdom,
                _character.Charisma,
                _character.SavingThrowStrength,
                _character.SavingThrowDexterity,
                _character.SavingThrowConstitution,
                _character.SavingThrowIntelligence,
                _character.SavingThrowWisdom,
                _character.SavingThrowCharisma,
                _character.Acrobatics,
                _character.AnimalHandling,
                _character.Arcana,
                _character.Athletics,
                _character.Deception,
                _character.History,
                _character.Insight,
                _character.Intimidation,
                _character.Investigation,
                _character.Medicine,
                _character.Nature,
                _character.Perception,
                _character.Performance,
                _character.Persuasion,
                _character.Religion,
                _character.SlightOfHand,
                _character.Stealth,
                _character.Survival,
                new(_character.FirstLevelSpellSlotTotal, _character.FirstLevelSpellSlotUsed),
                new(_character.SecondLevelSpellSlotTotal, _character.SecondLevelSpellSlotUsed),
                new(_character.ThirdLevelSpellSlotTotal, _character.ThirdLevelSpellSlotUsed),
                new(_character.FourthLevelSpellSlotTotal, _character.FourthLevelSpellSlotUsed),
                new(_character.FifthLevelSpellSlotTotal, _character.FifthLevelSpellSlotUsed),
                new(_character.SixthLevelSpellSlotTotal, _character.SixthLevelSpellSlotUsed),
                new(_character.SeventhLevelSpellSlotTotal, _character.SeventhLevelSpellSlotUsed),
                new(_character.EighthLevelSpellSlotTotal, _character.EighthLevelSpellSlotUsed),
                new(_character.NinthLevelSpellSlotTotal, _character.NinthLevelSpellSlotUsed)
            );

            _character.CurrentPoints = _character.HitPoints;

            var response = await CharacterApi.CreateAsync(CampaignId, character);

            success = response.Match(_ => true, _ => false);
        }

        if (success)
        {
            _isEditMode = false;
            StateHasChanged();
        }
    }

    private void OnDragStart(CharacterInformation character)
    {
        if (_characterId is { } characterId)
        {
            var data = new CharactersDto(characterId, "", "", []); // ToDo: Dirty Fix
            DragAndDrop.Data = data;
        }
    }

    private static string FormatSkill(int value)
    {
        return value > 0 ? $"+{value}" : value.ToString();
    }

    private static int AbilityModifier(int score)
    {
        // D&D 5e modifier formula: floor((score - 10) / 2)
        return (int)Math.Floor((score - 10) / 2.0);
    }

    private void OnEdit(MouseEventArgs args)
    {
        _isEditMode = true;
        StateHasChanged();
    }

    private async Task OnSpellSlotChanged(int level, int used)
    {
        if (_characterId is { } characterId)
        {
            var payload = new CharacterSpellSlotUpdate(level, used);
            await CharacterApi.UpdateSpellSlotsAsync(characterId, payload);
        }
    }

    private async Task OnHitPointsChanged(int hitPoints)
    {
        if (_characterId is { } characterId)
        {
            var payload = new CharacterHealthUpdate(hitPoints);
            await CharacterApi.UpdateHealthAsync(characterId, payload);
        }
    }

    private async Task OnLoadImage()
    {
        await JsRuntime.InvokeVoidAsync("triggerClick", "characterCreationInputFile");
    }

    private async Task LoadCharacterImage(InputFileChangeEventArgs e, CharacterInformation character)
    {
        try
        {
            var file = e.File;

            await using var stream = file.OpenReadStream(maxAllowedSize: file.Size);

            var image = new byte[file.Size];
            var totalBytesRead = 0;

            while (totalBytesRead < file.Size)
            {
                var bytesRead = await stream.ReadAsync(image, totalBytesRead, (int)(file.Size - totalBytesRead));
                totalBytesRead += bytesRead;
                if (bytesRead == 0) break;
            }

            character.Image = image;
        }
        catch { }
    }
}