name: Deploy Backend

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build backend Docker image
      run: |
        docker build -t pen-and-paper-backend:latest -f Backend.Dockerfile .

    - name: Save image to tar
      run: |
        IMAGE_FILE=/tmp/backend.tar
        docker save pen-and-paper-backend:latest -o $IMAGE_FILE

    - name: Prepare SSH
      env:
        HOST: ${{ secrets.DEPLOY_HOST }}
        SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "${SSH_KEY}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan "$HOST" >> ~/.ssh/known_hosts || true

    - name: Upload image and deploy on server
      env:
        HOST: ${{ secrets.DEPLOY_HOST }}
        USER: ${{ secrets.DEPLOY_USER }}
      run: |
        DEST=/tmp
        IMAGE_FILE=/tmp/backend.tar

        BASENAME=$(basename "$IMAGE_FILE")
        REMOTE_TAR="$DEST/$BASENAME"
        scp $IMAGE_FILE ${USER}@${HOST}:$DEST/

        ssh ${USER}@${HOST} "set -e
          # stop and remove existing container, then remove old images
          docker stop PenAndPaperBackend || true
          docker rm -f PenAndPaperBackend || true
          docker images pen-and-paper-backend -q | xargs -r docker rmi -f || true
          # load the new image and start container
          docker load -i '$REMOTE_TAR'
          rm -f '$REMOTE_TAR' || true
          docker run --name PenAndPaperBackend --network caddy-net -d --restart unless-stopped \
            -e \"ConnectionStrings__PostgresDb=${{ secrets.POSTGRES_CONNECTION }}\" \
            -e \"Google__AccessTokenEndpoint=https://oauth2.googleapis.com/tokeninfo\" \
            -e \"Google__Authority=https://accounts.google.com\" \
            -e \"Google__ValidIssuer=https://accounts.google.com\" \
            -e \"Google__ValidAudience=${{ secrets.GOOGLE_VALID_AUDIENCE }}\" \
            -e \"JWT__Key=${{ secrets.JWT_KEY }}\" \
            -e \"JWT__Issuer=${{ secrets.JWT_ISSUER }}\" \
            -e \"JWT__Audience=PenAndPaperBackend\" \
            -p 8080:8080 pen-and-paper-backend:latest
          docker image prune -af || true"
